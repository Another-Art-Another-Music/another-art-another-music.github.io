<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Kargyraa</title>
<style>
:root{
  --bg:#0b0b0d; --fg:#eef; --line:#262633;
  --btn:#1f1f2a; --warn:#3b2630; --mut:#a7a7b2;
}
html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:13px/1.15 ui-monospace,monospace}
.wrap{max-width:900px;margin:auto;padding:8px}

/* header */
.header{
  display:flex;align-items:center;gap:6px;
  position:sticky;top:0;z-index:10;
  padding:8px 0;background:rgba(11,11,13,.95);
}
.hdr{color:var(--mut);font-weight:700;white-space:nowrap}

/* master */
.masterLine{
  display:flex;align-items:center;gap:6px;
  border:1px solid var(--line);
  border-radius:12px;padding:6px;
  flex:1;min-width:0;
}
button{
  background:var(--btn);color:var(--fg);
  border:1px solid var(--line);
  border-radius:10px;padding:7px 9px;
  cursor:pointer;-webkit-tap-highlight-color: transparent;
}
button:disabled{opacity:.5;cursor:default}
.masterLine input{flex:1;height:28px;min-width:0;touch-action: pan-y}
.xbtn{border-color:var(--warn)}
.xbtn.on{background:#2b1218}
.micbtn.on{border-color:rgba(255,255,255,.25)}

/* spectrum row (SECOND ROW) */
.specRow{
  border:1px solid var(--line);
  border-radius:12px;
  padding:6px;
  margin-top:8px;
  background:#0f0f14;
}
.specTop{
  display:flex;align-items:center;gap:6px;
  margin-bottom:6px;
}
.specLabel{color:var(--mut);font-weight:700;white-space:nowrap}
.specTop .hint{color:var(--mut);font-size:12px;white-space:nowrap;opacity:.85}
.specTop .sp{flex:1}
#spec{
  width:100%;
  height:160px;
  display:block;
  border-radius:10px;
  background:#0b0b0d;
  border:1px solid rgba(255,255,255,.06);
  touch-action:none;
}

/* layers */
.layers{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.layer{border:1px solid var(--line);border-radius:12px;padding:6px}
.row{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;min-width:0}
.row + .row{margin-top:6px}

/* TOP ROW: 3 sections */
.topRow{display:flex;align-items:center;gap:6px;touch-action:none}

/* zones: small finger size */
.zone{
  width:44px; min-width:44px; height:34px;
  display:flex;align-items:center;justify-content:center;
  border-radius:10px;
  user-select:none;
  font-size:12px;
}
.idxZone{color:#000;font-weight:800}
.noteZone{
  color:var(--mut);
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.08);
}

/* center < [edit] > */
.centerCtl{
  display:flex;align-items:center;gap:4px;
  flex:1;min-width:0;
  justify-content:center;
}
.stepBtn{
  min-width:28px;
  padding:6px 7px;
  border-radius:10px;
}
.freqEdit{
  width:86px;
  max-width:38vw;
  background:transparent;
  color:var(--fg);
  border:1px solid rgba(255,255,255,.10);
  border-radius:10px;
  padding:6px 8px;
  font-weight:800;
  font-size:14px;
  line-height:1;
  text-align:center;
  outline:none;
}
.freqEdit:focus{border-color:rgba(255,255,255,.22)}

/* volume row */
.cb{width:18px;height:18px;margin:0}
.lv{width:28px;text-align:left;color:var(--mut);font-weight:700;flex:0 0 auto}
.vol{flex:1;height:30px;min-width:0;touch-action: pan-y}
input[type=range]{width:100%}

/* presets (bottom) */
.presets{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:12px;
  padding:8px;
}
.pTitle{color:var(--mut);font-weight:700;margin:0 0 6px 0}
.pItem{display:flex;gap:6px;align-items:flex-start;margin:6px 0}
.pItem button{padding:6px 8px;border-radius:10px;white-space:nowrap}
.pText{color:var(--mut);font-size:12px;line-height:1.25}
</style>
</head>
<body>
<div class="wrap">

<div class="header">
  <div class="hdr">Kargyraa</div>
  <button id="btnS">S</button>
  <button id="btnMic" class="micbtn" disabled>M</button>
  <button id="btnAdd" disabled>+</button>

  <div class="masterLine">
    <input id="masterVol" type="range" min="0" max="1" step="0.001" value="0.9" disabled>
    <button id="masterX" class="xbtn" disabled>X</button>
  </div>
</div>

<!-- SECOND ROW: spectrum -->
<div class="specRow">
  <div class="specTop">
    <div class="specLabel">spectrum</div>
    <div class="hint">tap M, allow mic · tap spectrum = freeze</div>
    <div class="sp"></div>
    <div class="hint" id="specInfo">MIC off</div>
  </div>
  <canvas id="spec"></canvas>
</div>

<!-- layers only AFTER spectrum -->
<div id="layers" class="layers"></div>

<div class="presets" id="presets">
  <div class="pTitle">presets</div>
</div>

</div>

<script>
(function(){
"use strict";

var AC = window.AudioContext || window.webkitAudioContext;

var ctx = null;
var master = null;

var running = 0;
var masterMuted = 0;
var masterSaved = 0.9;

var btnS = document.getElementById("btnS");
var btnMic = document.getElementById("btnMic");
var btnAdd = document.getElementById("btnAdd");
var masterVol = document.getElementById("masterVol");
var masterX = document.getElementById("masterX");
var layersEl = document.getElementById("layers");
var presetsEl = document.getElementById("presets");

var spec = document.getElementById("spec");
var specInfo = document.getElementById("specInfo");
var g2 = spec.getContext("2d");

var NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
var COLORS = ["#ff4d4d","#ff9f1a","#ffd60a","#2ecc71","#1abc9c","#00bbff","#3d7eff","#a66bff","#ff5bd6"];

var layers = []; // [{osc,vol,gL,gR,merger}]
var nextIndex = 1;

/* mic/analyser */
var micOn = 0;
var micStream = null;
var micSrc = null;
var ana = null;

/* spectrum freeze + snapshot */
var specFreeze = 0;
var specLast = null;     // Uint8Array snapshot
var specLastSR = 48000;
var specLastN = 0;

function clamp(x,a,b){ return x<a?a : (x>b?b:x); }

function smooth(param, v){
  if(!ctx) return;
  var t = ctx.currentTime;
  try{
    param.cancelScheduledValues(t);
    param.setValueAtTime(param.value, t);
    param.linearRampToValueAtTime(v, t + 0.02);
  }catch(e){
    try{ param.value = v; }catch(e2){}
  }
}

function levelXX(v){
  var n = Math.round(clamp(+v,0,1) * 99);
  return (n<10 ? "0" : "") + n;
}

function noteLabel(f){
  f = +f;
  if(!(f>0)) return "--";
  var m = 69 + 12*Math.log(f/440)/Math.log(2);
  var mi = Math.round(m);
  var f0 = 440*Math.pow(2, (mi-69)/12);
  var cents = 1200*Math.log(f/f0)/Math.log(2);
  var name = NOTE_NAMES[((mi%12)+12)%12];
  var oct = Math.floor(mi/12) - 1;
  var c = Math.round(cents);
  if (c === 0) return name + oct + "0c";
  return name + oct + (c>0 ? "+" : "") + c + "c";
}

function hzText(f){
  var v = clamp(+f, 1, 24000);
  return v.toFixed(1);
}

// parse "440.5" or "D#4" / "Db4"
function parseFreqText(s){
  if(s == null) return NaN;
  s = String(s).trim();
  if(!s) return NaN;

  if (s.indexOf(",") >= 0) s = s.replace(",", ".");

  var n = parseFloat(s);
  if (isFinite(n)) return n;

  var m = /^([A-Ga-g])\s*([#b]?)\s*(-?\d+)$/.exec(s);
  if(!m) return NaN;

  var L = m[1].toUpperCase();
  var acc = m[2] || "";
  var oct = parseInt(m[3], 10);

  var base = {C:0,D:2,E:4,F:5,G:7,A:9,B:11}[L];
  if(base == null) return NaN;
  if(acc === "#") base += 1;
  else if(acc === "b") base -= 1;

  var midi = (oct + 1) * 12 + base;
  if(!(midi >= 0 && midi <= 127)) return NaN;

  return 440 * Math.pow(2, (midi - 69)/12);
}

/* DPR-aware canvas so text is readable on mobile */
function specResize(){
  var dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  var cssW = spec.clientWidth || 1;
  var cssH = spec.clientHeight || 160;

  var pxW = (cssW * dpr) | 0;
  var pxH = (cssH * dpr) | 0;

  if (spec.width !== pxW || spec.height !== pxH){
    spec.width = pxW;
    spec.height = pxH;

    // draw in CSS pixels
    g2.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
}
window.addEventListener("resize", specResize, {passive:true});
specResize();

/* tap spectrum = freeze */
spec.addEventListener("pointerdown", function(e){
  specFreeze = !specFreeze;
  specInfo.textContent = specFreeze ? (micOn ? "MIC on (freeze)" : "freeze") : (micOn ? "MIC on" : "MIC off");
  e.preventDefault();
}, {passive:false});

function ensureAudio(){
  if(ctx) return 1;
  try{ ctx = new AC(); }catch(e){ alert("Audio init failed"); return 0; }
  master = ctx.createGain();
  master.gain.value = +masterVol.value;
  master.connect(ctx.destination);
  return 1;
}

function stopAllLayers(){
  for(var i=0;i<layers.length;i++){
    var L = layers[i];
    try{ smooth(L.vol.gain, 0); }catch(e){}
    try{ L.osc.stop(ctx.currentTime + 0.03); }catch(e){}
    try{ L.osc.disconnect(); }catch(e){}
    try{ L.vol.disconnect(); }catch(e){}
    try{ L.gL.disconnect(); }catch(e){}
    try{ L.gR.disconnect(); }catch(e){}
    try{ L.merger.disconnect(); }catch(e){}
  }
  layers = [];
  layersEl.innerHTML = "";
  nextIndex = 1;
}

/* ---------- mic ---------- */

function stopMic(){
  micOn = 0;
  btnMic.classList.remove("on");
  specInfo.textContent = specFreeze ? "freeze" : "MIC off";

  if (micSrc){ try{ micSrc.disconnect(); }catch(e){} micSrc = null; }
  if (ana){ try{ ana.disconnect(); }catch(e){} ana = null; }
  if (micStream){
    try{
      var tracks = micStream.getTracks();
      for (var i=0;i<tracks.length;i++) tracks[i].stop();
    }catch(e){}
    micStream = null;
  }
}

function startMic(){
  if (!ctx) return;
  navigator.mediaDevices.getUserMedia({
    audio: {
      echoCancellation:false,
      noiseSuppression:false,
      autoGainControl:false
    }
  }).then(function(stream){
    micStream = stream;
    micSrc = ctx.createMediaStreamSource(stream);

    ana = ctx.createAnalyser();
    ana.fftSize = 4096;
    ana.smoothingTimeConstant = 0.7;
    micSrc.connect(ana);

    micOn = 1;
    btnMic.classList.add("on");
    specInfo.textContent = specFreeze ? "MIC on (freeze)" : "MIC on";
  }).catch(function(err){
    alert("mic denied: " + err);
    stopMic();
  });
}

btnMic.onclick = function(){
  if (!running) return;
  if (!micOn) startMic();
  else stopMic();
};

/* log map */
function hzToX_log(hz, fMin, fMax, w){
  var a = Math.log(hz/fMin) / Math.log(fMax/fMin);
  return a * w;
}

/* peak picking */
function findPeaks(data, binHz, fMin, fMax){
  var peaks = [];
  var iMin = Math.max(2, Math.floor(fMin / binHz));
  var iMax = Math.min(data.length - 3, Math.floor(fMax / binHz));

  // adaptive threshold so labels show even on quiet mic
  var mx = 0;
  for (var i=iMin;i<=iMax;i++){
    var v = data[i];
    if (v > mx) mx = v;
  }
  var thr = Math.max(10, Math.floor(mx * 0.55));

  for (var i=iMin;i<=iMax;i++){
    var v = data[i];
    if (v < thr) continue;
    if (v >= data[i-1] && v >= data[i+1] && v > data[i-2] && v > data[i+2]){
      peaks.push({i:i, v:v});
    }
  }

  peaks.sort(function(a,b){ return b.v - a.v; });

  var out = [];
  var minHzSep = 30;

  for (var k=0;k<peaks.length;k++){
    var hz = peaks[k].i * binHz;
    if (!(hz>=fMin && hz<=fMax)) continue;

    var ok = 1;
    for (var j=0;j<out.length;j++){
      if (Math.abs(out[j].hz - hz) < minHzSep) { ok = 0; break; }
    }
    if (!ok) continue;

    out.push({hz:hz, v:peaks[k].v});
    if (out.length >= 3) break;
  }
  return out;
}

/* spectrum draw loop */
function drawSpectrum(){
  requestAnimationFrame(drawSpectrum);

  specResize();

  var w = spec.clientWidth|0;
  var h = spec.clientHeight|0;

  // background
  g2.globalAlpha = 1;
  g2.fillStyle = "#0b0b0d";
  g2.fillRect(0,0,w,h);

  var fMin = 40;
  var sr = ctx ? ctx.sampleRate : 48000;
  var fMax = Math.min(8000, (sr/2));

  // grid/ticks
  var ticks = [50,100,200,400,800,1600,3200,6400];
  g2.font = "11px ui-monospace,monospace";
  g2.textBaseline = "alphabetic";
  for (var t=0;t<ticks.length;t++){
    var hzT = ticks[t];
    if (hzT < fMin || hzT > fMax) continue;
    var xx = hzToX_log(hzT, fMin, fMax, w);
    g2.globalAlpha = 0.22;
    g2.fillStyle = "#eef";
    g2.fillRect(xx, 0, 1, h);
    g2.globalAlpha = 0.7;
    g2.fillStyle = "#a7a7b2";
    g2.fillText(String(hzT), xx+3, h-6);
  }

  if (!ana || !ctx){
    g2.globalAlpha = 0.9;
    g2.fillStyle = "#a7a7b2";
    g2.fillText("no analyser", 10, 18);
    if (specFreeze){
      g2.globalAlpha = 0.85;
      g2.fillStyle = "#0b0b0d";
      g2.fillRect(8, 6, 84, 18);
      g2.globalAlpha = 1;
      g2.fillStyle = "#a7a7b2";
      g2.font = "12px ui-monospace,monospace";
      g2.fillText("FREEZE", 12, 20);
    }
    return;
  }

  var n = ana.frequencyBinCount;

  // live or frozen snapshot
  var data;
  if (specFreeze && specLast && specLastN === n){
    data = specLast;
    sr = specLastSR;
  }else{
    data = new Uint8Array(n);
    ana.getByteFrequencyData(data);
    specLast = data;
    specLastSR = sr;
    specLastN = n;
  }

  var binHz = (sr/2) / n;

  // spectrum polyline
  g2.globalAlpha = 1;
  g2.strokeStyle = "#eef";
  g2.lineWidth = 1;
  g2.beginPath();

  var first = 1;
  for (var i=1;i<n;i++){
    var hz = i * binHz;
    if (hz < fMin || hz > fMax) continue;

    var x = hzToX_log(hz, fMin, fMax, w);
    var v = data[i] / 255;
    var y = h - (v * (h-22)) - 8;

    if (first){
      g2.moveTo(x,y);
      first = 0;
    }else{
      g2.lineTo(x,y);
    }
  }
  g2.stroke();

  // PEAKS (top 3)
  var peaks = findPeaks(data, binHz, fMin, fMax);

  g2.font = "12px ui-monospace,monospace";
  g2.textBaseline = "top";

  if (!peaks.length){
    g2.globalAlpha = 0.9;
    g2.fillStyle = "#a7a7b2";
    g2.fillText("no peaks (try louder / closer)", 10, 8);
  }else{
    for (var p=0;p<peaks.length;p++){
      var hzP = peaks[p].hz;
      var xP = hzToX_log(hzP, fMin, fMax, w);

      // marker
      g2.globalAlpha = 0.95;
      g2.fillStyle = "#eef";
      g2.fillRect(xP, 0, 1, h);

      // label
      var txt = Math.round(hzP) + "Hz " + noteLabel(hzP);
      var tx = xP + 4;
      var ty = 6 + p*16;

      if (tx > w - 240) tx = xP - 4 - 240;
      if (tx < 2) tx = 2;

      g2.globalAlpha = 0.85;
      g2.fillStyle = "#0b0b0d";
      g2.fillRect(tx-3, ty-2, 240, 16);

      g2.globalAlpha = 1;
      g2.strokeStyle = "#000";
      g2.lineWidth = 3;
      g2.strokeText(txt, tx, ty);

      g2.fillStyle = "#eef";
      g2.fillText(txt, tx, ty);
    }
  }

  if (specFreeze){
    g2.globalAlpha = 0.85;
    g2.fillStyle = "#0b0b0d";
    g2.fillRect(8, 6, 84, 18);
    g2.globalAlpha = 1;
    g2.fillStyle = "#a7a7b2";
    g2.font = "12px ui-monospace,monospace";
    g2.textBaseline = "alphabetic";
    g2.fillText("FREEZE", 12, 20);
  }
}
drawSpectrum();

/* ---------- layers ---------- */

function createLayerNodes(freq){
  var osc = ctx.createOscillator();
  osc.type = "sine";
  osc.frequency.value = freq;

  var vol = ctx.createGain();
  vol.gain.value = 0.15;

  var gL = ctx.createGain(); gL.gain.value = 1;
  var gR = ctx.createGain(); gR.gain.value = 1;

  var merger = ctx.createChannelMerger(2);

  osc.connect(vol);
  vol.connect(gL);
  vol.connect(gR);

  gL.connect(merger, 0, 0);
  gR.connect(merger, 0, 1);

  merger.connect(master);

  osc.start();

  return {osc:osc, vol:vol, gL:gL, gR:gR, merger:merger};
}

function mkBtn(txt, cls){
  var b = document.createElement("button");
  b.textContent = txt;
  if(cls) b.className = cls;
  return b;
}

function addLayer(freq, initVol, initL, initR){
  freq = clamp(+freq, 1, 24000);

  var idx = nextIndex++;
  var color = COLORS[(idx-1) % COLORS.length];

  var nodes = createLayerNodes(freq);

  var root = document.createElement("div");
  root.className = "layer";

  // top row: [IDX] [< edit >] [NOTE]
  var top = document.createElement("div");
  top.className = "topRow";

  var incZone = document.createElement("div");
  incZone.className = "zone idxZone";
  incZone.style.background = color;
  incZone.textContent = String(idx);

  var center = document.createElement("div");
  center.className = "centerCtl";

  var bM = mkBtn("<","stepBtn");

  var fEdit = document.createElement("input");
  fEdit.type = "text";
  fEdit.inputMode = "decimal";
  fEdit.autocapitalize = "none";
  fEdit.autocomplete = "off";
  fEdit.spellcheck = false;
  fEdit.className = "freqEdit";
  fEdit.value = hzText(freq);

  var bP = mkBtn(">","stepBtn");

  center.appendChild(bM);
  center.appendChild(fEdit);
  center.appendChild(bP);

  var decZone = document.createElement("div");
  decZone.className = "zone noteZone";
  decZone.textContent = noteLabel(freq);

  top.appendChild(incZone);
  top.appendChild(center);
  top.appendChild(decZone);

  // vol row: [L][R][XX][slider]
  var vr = document.createElement("div");
  vr.className = "row";

  var Lc = document.createElement("input");
  Lc.type = "checkbox"; Lc.className = "cb"; Lc.checked = (initL !== 0);

  var Rc = document.createElement("input");
  Rc.type = "checkbox"; Rc.className = "cb"; Rc.checked = (initR !== 0);

  var lv = document.createElement("span");
  lv.className = "lv";

  var vsl = document.createElement("input");
  vsl.type = "range"; vsl.min = 0; vsl.max = 1; vsl.step = 0.001;
  vsl.className = "vol";

  vr.appendChild(Lc);
  vr.appendChild(Rc);
  vr.appendChild(lv);
  vr.appendChild(vsl);

  root.appendChild(top);
  root.appendChild(vr);
  layersEl.appendChild(root);

  function applyLR(){
    smooth(nodes.gL.gain, Lc.checked ? 1 : 0);
    smooth(nodes.gR.gain, Rc.checked ? 1 : 0);
  }

  function setVol(v){
    v = clamp(+v, 0, 1);
    lv.textContent = levelXX(v);
    smooth(nodes.vol.gain, v);
  }

  function setFreq(v, writeEdit){
    v = clamp(+v, 1, 24000);
    smooth(nodes.osc.frequency, v);
    decZone.textContent = noteLabel(v);
    if(writeEdit) fEdit.value = hzText(v);
  }

  function step(d){
    setFreq(nodes.osc.frequency.value + d*0.1, true);
  }

  function tryEditLive(){
    var v = parseFreqText(fEdit.value);
    if(v>0) setFreq(v, false);
  }
  function commitEdit(){
    var v = parseFreqText(fEdit.value);
    if(!(v>0)){
      fEdit.value = hzText(nodes.osc.frequency.value);
      return;
    }
    setFreq(v, true);
  }

  bM.onclick = function(){ step(-1); };
  bP.onclick = function(){ step(+1); };

  fEdit.addEventListener("input", function(){ tryEditLive(); }, {passive:true});
  fEdit.addEventListener("blur", function(){ commitEdit(); }, {passive:true});
  fEdit.addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      commitEdit();
      fEdit.blur();
    }
  });

  Lc.onchange = applyLR;
  Rc.onchange = applyLR;

  vsl.oninput = function(){ setVol(vsl.value); };

  // drag zones: SAME direction both zones (→ inc, ← dec)
  var drag = {on:0, x0:0, f0:freq};
  var DRAG_HZ_PER_PX = 2.0;

  function down(e){
    var tag = (e.target.tagName||"").toLowerCase();
    if(tag === "input" || tag === "button") return;

    drag.on = 1;
    drag.x0 = e.clientX;
    drag.f0 = nodes.osc.frequency.value;
    if(e.currentTarget.setPointerCapture) e.currentTarget.setPointerCapture(e.pointerId);
    e.preventDefault();
  }
  function move(e){
    if(!drag.on) return;
    var dx = e.clientX - drag.x0;
    setFreq(drag.f0 + dx*DRAG_HZ_PER_PX, true);
    e.preventDefault();
  }
  function up(e){
    drag.on = 0;
    e.preventDefault();
  }

  incZone.addEventListener("pointerdown", down, {passive:false});
  decZone.addEventListener("pointerdown", down, {passive:false});
  incZone.addEventListener("pointermove", move, {passive:false});
  decZone.addEventListener("pointermove", move, {passive:false});
  incZone.addEventListener("pointerup", up, {passive:false});
  decZone.addEventListener("pointerup", up, {passive:false});
  incZone.addEventListener("pointercancel", up, {passive:false});
  decZone.addEventListener("pointercancel", up, {passive:false});

  // init
  applyLR();
  setVol((initVol == null) ? 0.15 : initVol);
  vsl.value = (initVol == null) ? 0.15 : initVol;
  setFreq(freq, true);

  layers.push(nodes);
}

/* ------------------ presets ------------------ */

var PRESETS = [
  {
    name: "Kargyraa",
    text: "Drone + overtone scanner. 65.4 Hz (C2) + 800 Hz.",
    layers: [
      {f:65.4, v:0.18, L:1, R:1},
      {f:800,  v:0.12, L:1, R:1}
    ]
  },
  {
    name: "Harmonics 55",
    text: "Jaw-harp harmonic stack. 55(1..6).",
    layers: [
      {f:55,  v:0.14, L:1, R:1},
      {f:110, v:0.10, L:1, R:1},
      {f:165, v:0.08, L:1, R:1},
      {f:220, v:0.07, L:1, R:1},
      {f:275, v:0.06, L:1, R:1},
      {f:330, v:0.05, L:1, R:1}
    ]
  },
  {
    name: "Binaural 200/206",
    text: "Beat (6 Hz). Left 200 Hz, Right 206 Hz.",
    layers: [
      {f:200, v:0.14, L:1, R:0},
      {f:206, v:0.14, L:0, R:1}
    ]
  }
];

function renderPresets(){
  while(presetsEl.childNodes.length > 1) presetsEl.removeChild(presetsEl.lastChild);

  for(var i=0;i<PRESETS.length;i++){
    (function(P){
      var item = document.createElement("div");
      item.className = "pItem";

      var b = document.createElement("button");
      b.textContent = P.name;
      b.onclick = function(){ applyPreset(P); };

      var t = document.createElement("div");
      t.className = "pText";
      t.textContent = P.text;

      item.appendChild(b);
      item.appendChild(t);
      presetsEl.appendChild(item);
    })(PRESETS[i]);
  }
}

function applyPreset(P){
  function go(){
    stopAllLayers();
    for(var i=0;i<P.layers.length;i++){
      var L = P.layers[i];
      addLayer(L.f, L.v, L.L, L.R);
    }
  }
  if(!running){
    start(go);
  }else{
    go();
  }
}

/* ------------------ transport ------------------ */

function start(after){
  if(!ensureAudio()) return;
  ctx.resume().then(function(){
    running = 1;

    btnAdd.disabled = false;
    btnMic.disabled = false;
    masterVol.disabled = false;
    masterX.disabled = false;

    // master hooks
    masterVol.oninput = function(){
      masterSaved = clamp(+masterVol.value, 0, 1);
      if(!masterMuted && master) smooth(master.gain, masterSaved);
    };

    masterX.onclick = function(){
      masterMuted = !masterMuted;
      masterX.classList.toggle("on", masterMuted);
      if(master) smooth(master.gain, masterMuted ? 0 : masterSaved);
    };

    masterSaved = clamp(+masterVol.value, 0, 1);
    smooth(master.gain, masterMuted ? 0 : masterSaved);

    if(after) after();
    else if(layers.length === 0){
      // DEFAULT: 65.4 and 800
      addLayer(65.4, 0.18, 1, 1);
      addLayer(800,  0.12, 1, 1);
    }
  }).catch(function(){
    alert("resume failed");
  });
}

function stop(){
  stopMic();
  stopAllLayers();

  try{ ctx.close(); }catch(e){}
  ctx = null; master = null;

  running = 0;

  masterMuted = 0;
  masterX.classList.remove("on");
  masterVol.value = "0.9";
  masterSaved = 0.9;

  btnAdd.disabled = true;
  btnMic.disabled = true;
  masterVol.disabled = true;
  masterX.disabled = true;
}

btnS.onclick = function(){
  if(!running) start(null);
  else stop();
};

btnAdd.onclick = function(){ if(ctx) addLayer(220, 0.12, 1, 1); };

renderPresets();

})();
</script>
</body>
</html>